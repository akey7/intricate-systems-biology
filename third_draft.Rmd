---
title: "Third Draft"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Functions

This will also load the parts of the tidyverse we need.

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(readr)
library(doParallel)
library(here)
source("simulation_functions.R")
```

## Make a theme for the plots

```{r}
theme_set(
  theme_linedraw() +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 9)
    )
)
```

## Setup Initial Conditions and Run Specs

```{r}
initial_condition_df <- cross_initial_conditions(
  x1 = c(0.75, 1, 1.25),
  x2 = c(0.75, 1, 1.25),
  x3 = c(0.75, 1, 1.25),
  x4 = c(0.75, 1, 1.25),
  x5 = c(0.75, 1, 1.25)
)

# run_specs <- create_run_specs(head(initial_condition_df))
run_specs <- create_run_specs(initial_condition_df)
```

## Use doParallel to Create All Plots

```{r}
cl <- makeCluster(4, type='PSOCK')
registerDoParallel(cl)

results <- foreach(i=1:length(run_specs), .packages = "tidyverse") %dopar% {
  initial_conditions_run_and_plot(
    run_name = run_specs[[i]][["run_name"]],
    x1_initial = run_specs[[i]][["ics"]][[1]],
    x2_initial = run_specs[[i]][["ics"]][[2]],
    x3_initial = run_specs[[i]][["ics"]][[3]],
    x4_initial = run_specs[[i]][["ics"]][[4]],
    x5_initial = run_specs[[i]][["ics"]][[5]]
  )
}

registerDoSEQ()
```

## Display a run name and sample plot

```{r}
results[[1]][["run_name"]]
```

```{r}
results[[1]][["simulation_plot"]]
```

## Write csvs

```{r}
combined_results <- combine_simulations_dfs(results)
write_csv(combined_results, here("output", "combined_results.csv"), col_names = TRUE, na = "")
```

## Write the plots on the same y axis

```{r}
write_plots(results)
```
